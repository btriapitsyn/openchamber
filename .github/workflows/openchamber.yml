name: OpenChamber for Actions

on:
  workflow_dispatch:
    inputs:
      tunnel_provider:
        description: 'Select Tunnel Provider'
        required: true
        default: 'cloudflare'
        type: choice
        options:
          - ngrok
          - cloudflare
      timeout_minutes:
        description: 'Auto-shutdown after (minutes)'
        required: true
        default: '300'
        type: string

jobs:
  serve:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ============================================================
      # PERSISTENCE: Restore previous session (OAuth, chats, config)
      # ============================================================
      - name: Restore Session Data (Artifact)
        uses: dawidd6/action-download-artifact@v6
        continue-on-error: true
        with:
          name: opencode-session
          path: /tmp/opencode-restore
          workflow: opencode.yml
          workflow_conclusion: success
          if_no_artifact_found: ignore
          repo: ${{ github.repository }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Apply Restored Session Data
        run: |
          chmod +x scripts/persistence-restore.sh
          RESTORE_DIR=/tmp/opencode-restore ./scripts/persistence-restore.sh

      # ============================================================
      # CACHE: Speed up npm installations
      # ============================================================
      - name: Cache npm modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
          key: npm-cache-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            npm-cache-${{ runner.os }}-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Tools
        run: |
          npm install -g opencode-ai @openchamber/web wetty
          sudo apt update && sudo apt install jq lsof coreutils -y

      # ============================================================
      # CONFIGURATION: Setup OpenCode config (respects artifacts)
      # ============================================================
      - name: Configure OpenCode
        run: |
          chmod +x scripts/opencode-config.sh
          RESTORE_DIR=/tmp/opencode-restore ./scripts/opencode-config.sh

      # ============================================================
      # STARTUP: Launch services and tunnel
      # ============================================================
      - name: Start Services
        run: |
          # Start OpenCode Web (Official)
          nohup stdbuf -oL opencode web --port 8080 > opencode.log 2>&1 &

          # Start OpenChamber (Web UI)
          nohup stdbuf -oL openchamber --port 9090 > openchamber.log 2>&1 &
          
          # Start WiTTY (Core TTY)
          # We use wetty to expose the 'opencode' command via web
          nohup stdbuf -oL wetty --port 3000 --base / --command opencode > wetty.log 2>&1 &

          # Wait for services to initialize
          sleep 20
          
          echo "Services started. Checking status..."
          lsof -i :8080 || echo "Warning: OpenCode Web may not be running"
          lsof -i :9090 || echo "Warning: OpenChamber may not be running"
          lsof -i :3000 || echo "Warning: WiTTY (Core) may not be running"

      - name: Setup Tunnel
        run: |
          if [[ "${{ github.event.inputs.tunnel_provider }}" == "ngrok" ]]; then
            echo "Setting up ngrok tunnel..."
            curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
            echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
            sudo apt update && sudo apt install ngrok -y
            ngrok config add-authtoken "${{ secrets.NGROK_AUTH_TOKEN }}"

            # Start ngrok for OpenChamber (default)
            nohup ngrok http 127.0.0.1:9090 --log=stdout > tunnel.log 2>&1 &
            sleep 10
            CHAMBER_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')

            echo "URL_WEB=Ngrok_Limited" >> $GITHUB_ENV
            echo "URL_CHAMBER=$CHAMBER_URL" >> $GITHUB_ENV
            echo "URL_TTY=Ngrok_Limited" >> $GITHUB_ENV

          else
            echo "Setting up Cloudflare tunnel..."
            wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
            sudo dpkg -i cloudflared-linux-amd64.deb

            # Start 3 distinct tunnels
            nohup cloudflared tunnel --url http://127.0.0.1:8080 > tunnel_web.log 2>&1 &
            nohup cloudflared tunnel --url http://127.0.0.1:9090 > tunnel_chamber.log 2>&1 &
            nohup cloudflared tunnel --url http://127.0.0.1:3000 > tunnel_tty.log 2>&1 &

            sleep 15

            echo "URL_WEB=$(grep -o 'https://[-a-z0-9.]*trycloudflare.com' tunnel_web.log | tail -n 1)" >> $GITHUB_ENV
            echo "URL_CHAMBER=$(grep -o 'https://[-a-z0-9.]*trycloudflare.com' tunnel_chamber.log | tail -n 1)" >> $GITHUB_ENV
            echo "URL_TTY=$(grep -o 'https://[-a-z0-9.]*trycloudflare.com' tunnel_tty.log | tail -n 1)" >> $GITHUB_ENV
          fi

      # ============================================================
      # MONITOR: Self-healing loop with status updates
      # ============================================================
      - name: Monitor & Self-Heal
        run: |
          chmod +x scripts/monitor.sh
          ./scripts/monitor.sh "${{ github.event.inputs.tunnel_provider }}" "${{ github.event.inputs.timeout_minutes }}" "${{ env.URL_WEB }}" "${{ env.URL_CHAMBER }}" "${{ env.URL_TTY }}"

      # ============================================================
      # PERSISTENCE: Save all session data (always runs)
      # ============================================================
      - name: Prepare Session Data for Save
        if: always()
        run: |
          chmod +x scripts/persistence-save.sh
          SAVE_DIR=/tmp/opencode-save ./scripts/persistence-save.sh

      - name: Upload Session Data (Artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: opencode-session
          path: /tmp/opencode-save/
          retention-days: 90
          overwrite: true
          if-no-files-found: warn

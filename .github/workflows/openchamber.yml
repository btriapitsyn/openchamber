name: OpenChamber

on:
  workflow_dispatch:
    inputs:
      app_mode:
        description: 'Select Application Mode'
        required: true
        default: 'OpenChamber'
        type: choice
        options:
          - OpenChamber
          - OpenCode Web
          - OpenCode CLI
      tunnel_provider:
        description: 'Select Tunnel Provider'
        required: true
        default: 'cloudflare'
        type: choice
        options:
          - ngrok
          - cloudflare
      timeout_minutes:
        description: 'Auto-shutdown after (minutes)'
        required: true
        default: '300'
        type: string

jobs:
  serve:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ============================================================
      # PERSISTENCE: Restore previous session
      # ============================================================
      - name: Restore Session Data (Artifact)
        uses: dawidd6/action-download-artifact@v6
        continue-on-error: true
        with:
          name: opencode-session
          path: /tmp/opencode-restore
          workflow: opencode.yml
          workflow_conclusion: success
          if_no_artifact_found: ignore
          repo: ${{ github.repository }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Apply Restored Session Data
        run: |
          echo "=== RESTORE DEBUG ==="
          if [ -d "/tmp/opencode-restore" ]; then
            echo "Restoring session files..."
            mkdir -p ~/.config/opencode ~/.local/share/opencode
            cp -rv /tmp/opencode-restore/config/* ~/.config/opencode/ 2>/dev/null || true
            cp -rv /tmp/opencode-restore/share/* ~/.local/share/opencode/ 2>/dev/null || true
            echo "Session restored successfully!"
          else
            echo "No previous session found. Fresh start."
          fi

      # ============================================================
      # SETUP & INSTALLATION
      # ============================================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Tools
        run: |
          # Install system dependencies
          sudo apt update && sudo apt install jq lsof coreutils -y

          echo "Selected Mode: ${{ github.event.inputs.app_mode }}"

          if [[ "${{ github.event.inputs.app_mode }}" == "OpenCode CLI" ]]; then
            echo "Installing Opencode CLI Tools & ttyd..."
            # Using npm instead of curl to prevent HTML/syntax errors
            npm install -g opencode-ai
            
            # Install ttyd
            wget -q -O ttyd https://github.com/tsl0922/ttyd/releases/download/1.7.3/ttyd.x86_64
            chmod +x ttyd
            sudo mv ttyd /usr/local/bin/
          else
            echo "Installing Full Suite (OpenCode + OpenChamber)..."
            npm install -g opencode-ai @openchamber/web
          fi

      - name: Configure OpenCode
        run: |
          mkdir -p ~/.config/opencode
          cat << 'EOF' > ~/.config/opencode/opencode.json
          {
            "$schema": "https://opencode.ai/config.json",
            "plugin": ["opencode-antigravity-auth@beta"],
            "provider": {
              "google": {
                "models": {
                  "gemini-3-flash-preview": {
                    "name": "Gemini 3 Flash Preview",
                    "limit": { "context": 1048576, "output": 65536 },
                    "modalities": { "input": ["text", "image", "pdf"], "output": ["text"] }
                  }
                }
              }
            }
          }
          EOF

      # ============================================================
      # STARTUP & TUNNELING
      # ============================================================
      - name: Initial Startup
        run: |
          MODE="${{ github.event.inputs.app_mode }}"
          TARGET_PORT=8080 # Default
          
          if [[ "$MODE" == "OpenChamber" ]]; then
            echo "Starting OpenChamber on port 9090..."
            nohup stdbuf -oL openchamber --port 9090 > openchamber.log 2>&1 &
            TARGET_PORT=9090
          elif [[ "$MODE" == "OpenCode Web" ]]; then
            echo "Starting OpenCode Web on port 8080..."
            nohup stdbuf -oL opencode web --port 8080 > opencode.log 2>&1 &
            TARGET_PORT=8080
          else 
            # CLI Mode
            echo "Starting OpenCode CLI (via ttyd) on port 8080..."
            nohup stdbuf -oL ttyd -p 8080 -W bash > opencode.log 2>&1 &
            TARGET_PORT=8080
          fi
          
          # Save port for next steps
          echo "TARGET_PORT=$TARGET_PORT" >> $GITHUB_ENV
          
          sleep 20
          
          # Initialize Tunnel
          if [[ "${{ github.event.inputs.tunnel_provider }}" == "ngrok" ]]; then
            curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
            echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
            sudo apt update && sudo apt install ngrok -y
            ngrok config add-authtoken "${{ secrets.NGROK_AUTH_TOKEN }}"
            nohup ngrok http 127.0.0.1:$TARGET_PORT --log=stdout > tunnel.log 2>&1 &
            sleep 10
            echo "URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')" >> $GITHUB_ENV
          else
            wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
            sudo dpkg -i cloudflared-linux-amd64.deb
            nohup cloudflared tunnel --url http://127.0.0.1:$TARGET_PORT > tunnel.log 2>&1 &
            sleep 15
            echo "URL=$(grep -o 'https://[-a-z0-9.]*trycloudflare.com' tunnel.log | tail -n 1)" >> $GITHUB_ENV
          fi

      - name: Monitor & Self-Heal
        run: |
          echo "------------------------------------------"
          echo "SERVER LIVE AT: ${{ env.URL }}"
          echo "MODE: ${{ github.event.inputs.app_mode }}"
          echo "PORT: ${{ env.TARGET_PORT }}"
          echo "------------------------------------------"
          
          START_TIME=$(date +%s)
          TIMEOUT_SECONDS=$(( ${{ github.event.inputs.timeout_minutes }} * 60 ))
          
          while true; do
            ELAPSED=$(( $(date +%s) - START_TIME ))
            REMAINING=$(( TIMEOUT_SECONDS - ELAPSED ))
            
            if [ $REMAINING -le 0 ]; then
              echo "Timeout reached. Shutting down."
              break
            fi
            
            # Print status every 5 mins
            if [ $(( ELAPSED % 300 )) -lt 10 ]; then
              echo "[$(date)] Remaining: $(( REMAINING / 60 )) min. URL: ${{ env.URL }}"
            fi
            
            # Simple process check
            if ! pgrep -f "opencode|openchamber|ttyd" > /dev/null; then
               echo "[$(date)] Process died! Restarting..."
               if [[ "${{ github.event.inputs.app_mode }}" == "OpenChamber" ]]; then
                 nohup stdbuf -oL openchamber --port 9090 >> openchamber.log 2>&1 &
               elif [[ "${{ github.event.inputs.app_mode }}" == "OpenCode Web" ]]; then
                 nohup stdbuf -oL opencode web --port 8080 >> opencode.log 2>&1 &
               else
                 nohup stdbuf -oL ttyd -p 8080 -W bash >> opencode.log 2>&1 &
               fi
            fi

            sleep 10
          done

      # ============================================================
      # SAVING SESSION
      # ============================================================
      - name: Prepare Session Data for Save
        if: always()
        run: |
          echo "Saving session data..."
          mkdir -p /tmp/opencode-save/config /tmp/opencode-save/share
          
          if [ -d "$HOME/.config/opencode" ]; then
            cp -rv $HOME/.config/opencode/* /tmp/opencode-save/config/ 2>/dev/null || true
          fi
          
          if [ -d "$HOME/.local/share/opencode" ]; then
            cp -rv $HOME/.local/share/opencode/* /tmp/opencode-save/share/ 2>/dev/null || true
          fi
          
      - name: Upload Session Data (Artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: opencode-session
          path: /tmp/opencode-save/
          retention-days: 30
          overwrite: true